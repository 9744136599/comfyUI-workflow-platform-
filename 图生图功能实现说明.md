# 图生图功能实现说明

## 功能概述

在原有的文生图功能基础上，添加了图生图（img2img）功能，支持用户上传图片后基于图片进行AI创作。

## 实现逻辑

### 1. 前端参数添加

在 `config` 对象中添加了 `image_name` 参数：
```javascript
const config = reactive({
  // ... 其他参数
  image_name: '' // 添加image_name参数，用于img2img模式
})
```

### 2. 上传文件处理

当用户上传PNG文件成功后，将返回的文件名赋值给 `config.image_name`：
```javascript
if (result.name) {
  // 将返回的文件名赋值给config.image_name，用于img2img模式
  config.image_name = result.name
}
```

### 3. 生成类型判断

后端根据 `image_name` 参数决定生成类型：
```javascript
// 根据image_name参数决定生成类型
const generationType = image_name && image_name.trim() ? 'img2img' : 'text2img';
console.log('生成类型:', generationType, image_name ? `(使用图片: ${image_name})` : '(纯文本生成)');
```

### 4. 工作流选择

- **text2img模式**: 使用 `text2img_basic.json` 工作流
- **img2img模式**: 使用 `img2img_basic.json` 工作流

### 5. 占位符替换

在 `img2img_basic.json` 工作流中，`INPUT_IMAGE` 占位符会被替换为上传的图片文件名：
```json
{
  "10": {
    "inputs": {
      "image": "{{INPUT_IMAGE}}"
    },
    "class_type": "LoadImage",
    "_meta": {
      "title": "Load Image"
    }
  }
}
```

## 使用流程

### 1. 文生图模式（默认）
1. 用户直接输入提示词
2. 选择模型和参数
3. 点击"开始创作"
4. 系统使用 `text2img_basic.json` 工作流

### 2. 图生图模式
1. 用户上传PNG图片
2. 系统自动设置 `image_name` 参数
3. 用户输入修改提示词
4. 选择模型和参数
5. 点击"开始创作"
6. 系统使用 `img2img_basic.json` 工作流，将上传的图片作为输入

## 界面提示

前端会显示当前生成模式：
- **文生图模式**: 蓝色提示框，显示"纯文本生成"
- **图生图模式**: 绿色提示框，显示"使用图片: filename.png"

## 技术实现

### 前端修改
- `frontend/src/views/Create.vue`: 添加 `image_name` 参数和模式提示

### 后端修改
- `rearend/controllers/generateController.js`: 添加 `image_name` 参数处理
- `rearend/services/comfyuiService.js`: 添加 `image_name` 参数和工作流占位符替换

### 工作流文件
- `rearend/workflows/img2img_basic.json`: 包含 `{{INPUT_IMAGE}}` 占位符

## API接口

### 生成图片接口
**请求参数**:
```javascript
{
  prompt: "修改提示词",
  negativePrompt: "负面提示词",
  model: "模型名称",
  size: "1024x1024",
  batchSize: 1,
  cfgScale: 7.5,
  steps: 25,
  seed: -1,
  sampler: "采样器名称",
  clipSkip: 2,
  image_name: "uploaded_image.png", // 新增参数
  frontendTaskId: "task_id"
}
```

**生成类型判断**:
- `image_name` 为空或空字符串 → `text2img` 模式
- `image_name` 有值 → `img2img` 模式

## 注意事项

1. **文件格式**: 仅支持PNG格式图片上传
2. **文件大小**: 限制为10MB
3. **图片处理**: 上传的图片会保存到ComfyUI服务器
4. **工作流兼容**: 确保ComfyUI服务器支持img2img工作流
5. **错误处理**: 如果img2img失败，会回退到模拟生成

## 扩展功能

这个实现为后续功能奠定了基础：
1. **局部重绘**: 可以基于上传的图片进行局部修改
2. **风格迁移**: 可以将上传图片的风格应用到生成结果
3. **批量处理**: 可以对多张图片进行批量处理
4. **高级编辑**: 可以添加更多图片编辑参数（如去噪强度等） 